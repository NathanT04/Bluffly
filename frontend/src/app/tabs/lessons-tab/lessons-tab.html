<div class="tab lessons-tab container-xl py-5">
  <ng-container *ngIf="!selectedLesson; else lessonDetail">
    <div class="row g-4 mb-4 align-items-center">
      <div class="col-lg-8">
        <h2>Lessons</h2>
        <p>
          Bite-sized concepts, quizzes, and scenarios to improve decision-making.
        </p>
      </div>
    </div>

    <div class="lesson-grid row row-cols-1 row-cols-md-3 g-4">
      <div
        class="col"
        *ngFor="let lesson of lessons"
        [attr.data-difficulty]="lesson.difficulty"
      >
        <article class="lesson-card h-100">
          <header class="lesson-card__header">
            <span class="lesson-card__difficulty">{{ lesson.difficultyLabel }}</span>
            <h3 class="lesson-card__title">{{ lesson.title }}</h3>
          </header>
          <p class="lesson-card__description">
            {{ lesson.description }}
          </p>
          <button type="button" class="lesson-card__cta" (click)="startLesson(lesson.difficulty)">
            {{ lesson.cta }}
          </button>
        </article>
      </div>
    </div>
  </ng-container>

  <ng-template #lessonDetail>
    <div class="lesson-detail row g-4">
      <div class="col-12">
        <button type="button" class="lesson-detail__back" (click)="exitLesson()">Back to lessons</button>
      </div>

      <div class="col-12">
        <header class="lesson-detail__header">
          <span class="lesson-detail__difficulty">{{ selectedLesson?.difficultyLabel }} Mode</span>
          <h2 class="lesson-detail__title">{{ selectedLesson?.title }}</h2>
          <p class="lesson-detail__description">
            {{ selectedLesson?.description }}
          </p>
        </header>
      </div>

      <div class="col-12">
        <section class="lesson-detail__body">
          <div #quizTop></div>

          <div *ngIf="isQuizLoading" class="lesson-feedback lesson-feedback--loading">
            Loading quiz questions…
          </div>

          <div *ngIf="!isQuizLoading && loadError" class="lesson-feedback lesson-feedback--error">
            <p>{{ loadError }}</p>
            <button type="button" (click)="retryLoad()">Try again</button>
          </div>

          <ng-container *ngIf="!isQuizLoading && !loadError">
            <div *ngIf="quizSubmitted && quizSummary" class="lesson-summary">
              <h3 class="lesson-summary__title">Quiz complete!</h3>
              <p class="lesson-summary__score">
                {{ quizSummary.correct }} / {{ quizSummary.total }} correct ({{ quizSummary.percentage }}%)
              </p>
            </div>

            <p *ngIf="quizQuestions.length === 0" class="lesson-feedback lesson-feedback--empty">
              No quiz questions available right now. Please try another difficulty or come back later.
            </p>

            <article
              class="lesson-question"
              *ngFor="let question of quizQuestions; let questionIndex = index"
            >
              <header class="lesson-question__header">
                <span class="lesson-question__index">Question {{ questionIndex + 1 }}</span>
                <h3 class="lesson-question__prompt">{{ question.prompt }}</h3>
              </header>

              <ul class="lesson-question__options">
                <li
                  class="lesson-question__option"
                  *ngFor="let option of question.options; let optionIndex = index"
                >
                  <button
                    type="button"
                    (click)="selectOption(question.id, optionIndex)"
                    [class.is-selected]="selectedOptions[question.id] === optionIndex"
                    [class.is-correct]="quizSubmitted && question.correctAnswerIndex === optionIndex"
                    [class.is-incorrect]="
                      quizSubmitted &&
                      selectedOptions[question.id] === optionIndex &&
                      question.correctAnswerIndex !== optionIndex
                    "
                    [disabled]="quizSubmitted"
                    [attr.aria-pressed]="selectedOptions[question.id] === optionIndex"
                  >
                    <span class="option-label">
                      {{ optionLabels[optionIndex] || (optionIndex + 1) }}
                    </span>
                    <span class="option-text">{{ option }}</span>
                  </button>
                </li>
              </ul>

              <div
                *ngIf="quizSubmitted"
                class="lesson-question__feedback"
                [class.lesson-question__feedback--correct]="isQuestionCorrect(question)"
                [class.lesson-question__feedback--incorrect]="!isQuestionCorrect(question)"
              >
                <strong>{{ isQuestionCorrect(question) ? 'Correct!' : 'Incorrect.' }}</strong>
                <span *ngIf="question.explanation"> {{ question.explanation }}</span>
                <span
                  *ngIf="
                    !isQuestionCorrect(question) &&
                    question.correctAnswerIndex !== undefined &&
                    question.correctAnswerIndex !== null
                  "
                >
                  Correct answer: {{ question.options[question.correctAnswerIndex] }}
                </span>
              </div>
            </article>

            <div *ngIf="quizQuestions.length > 0" class="lesson-actions lesson-actions--bottom">
              <p class="lesson-actions__status">
                {{ answeredCount }} / {{ quizQuestions.length }} answered
              </p>
              <button
                type="button"
                class="lesson-actions__submit"
                (click)="submitQuiz()"
                [disabled]="!canSubmitQuiz"
              >
                {{ quizSubmitted ? 'Quiz submitted' : 'Submit quiz' }}
              </button>
            </div>
          </ng-container>
        </section>
      </div>

      <div class="col-12" *ngIf="resultSaveError">
        <div class="lesson-feedback lesson-feedback--error">
          {{ resultSaveError }}
        </div>
      </div>

      <div class="col-12" *ngIf="recentResults.length > 0">
        <section class="lesson-history">
          <header class="lesson-history__header">
            <h3>Recent Results</h3>
            <span *ngIf="isSavingResult" class="lesson-history__status">Saving…</span>
          </header>

          <div class="row row-cols-1 row-cols-md-3 g-3">
            <div class="col" *ngFor="let result of recentResults">
              <div class="history-card">
                <div class="history-card__meta">
                  <span class="history-card__difficulty">{{ result.difficulty }}</span>
                  <time class="history-card__time">
                    {{ result.submittedAt | date : 'short' }}
                  </time>
                </div>
                <div class="history-card__score">
                  <strong>{{ result.correct }}</strong>
                  <span>/ {{ result.total }}</span>
                </div>
                <div class="history-card__percentage">
                  {{ result.percentage }}%
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </ng-template>
</div>
